@model ItemVM
@{
    ViewData["Title"] = "Bid History Details";
}

<h2>Bid History - @Model.Item.Name</h2>

<p><strong>Description:</strong> @Model.Item.Description</p>
<p><strong>Category:</strong> @Model.Item.Category?.Name</p>
<p><strong>Condition:</strong> @Model.Item.Condition</p>
<p><strong>Status:</strong> @Model.AuctionStatus</p>

@if (Model.AuctionStatus == AuctionStatus.InAuction)
{
    <h4>Live Top 5 Bids (Real-time)</h4>
    <div id="top5-bids-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        const itemId = @Model.Item.Id;

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/bidHub?itemId=" + itemId)
            .build();

        connection.start().then(() => {
            console.log("SignalR connected for history live top 5");
            loadTop5Bids();
        });

        connection.on("ReceiveBidUpdate", function (itemId) {
            loadTop5Bids();
        });

        function loadTop5Bids() {
            fetch(`/Bid/Top5?itemId=${itemId}`)
                .then(res => res.text())
                .then(html => {
                    document.getElementById("top5-bids-container").innerHTML = html;
                });
        }
    </script>
}
else
{
    @if (Model.BidList?.Any() == true)
    {
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Bid Amount</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var bid in Model.BidList.OrderByDescending(b => b.BidTime))
                {
                    <tr>
                        <td>@bid.User?.UserName</td>
                        <td>@bid.Amount.ToString("C")</td>
                        <td>@bid.BidTime.ToString("g")</td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p>No bids were placed for this item.</p>
    }
}
